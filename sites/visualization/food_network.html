<html>
  <head>
  <style>
     @import url('https://fonts.googleapis.com/css?Open+Sans+Condensed:300');

     body {
         text-align: center;
         font-size: 11pt;
         font-family: 'Verdana', sans-serif;
     }

     svg {
         font-size: 9pt;
         font-family: 'Open Sans Condensed', 'sans-serif';
     }

     #button {
         display: block;
         position: absolute;
         left: 5%;
         color: red;
     }

     #caption {
         font-style: italic;
         text-align: left;
         padding: 10px;
         padding-top: 5px;
         padding-bottom: 5px;
     }

  </style>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>

  <body>
    <h1>Visualizing Time Dependent Correlation Matrices</h1>
    <div id='button'>
        <p>
            Click to advance year <button>1970</button>               
        </p>
    </div>
    <svg id="graph"></svg>

    <div id="caption">
        This graph connects coutries by the similarity (correlation) of their
        food production. The data is based on a dataset by the
        <a href="http://www.fao.org/faostat">Food and Agriculture Organization 
            of the United Nations</a>. For example, fish-producing island
        countries are closely connected, and countries that grow similar
        vegetables because they are in similar latitudes for groups. The
        connections change and the graph adapts, as the years progress by
        clicking on the button below. This graph makes it possible to visualize
        time-dependent correlation matrices.
    </div>

    <script>
    var width = window.innerWidth,
        height = Math.min(width*0.85, window.innerHeight);

    var svg = d3.select('#graph')
        .attr('width', width)
        .attr('height', height);
    console.log(width, height);

    var center_x = width/2,
        center_y = height/2;
    var radius = center_y/2;

    function position_to_rad(x, y) {
      return 180 / Math.PI * Math.atan2(y, x);
    }

    function ticked(link, node) {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr('transform', function(d) {
                return 'translate('+d.x+','+d.y+')';});
    }

    function draw_data(data) {
      for(var i=0; i<data.nodes.length; i++){
          angle = Math.random()
          data.nodes[i].x = radius*Math.cos(angle*2*Math.PI) + center_x;
          data.nodes[i].y = radius*Math.sin(angle*2*Math.PI) + center_y;
      }
      var node = svg.append("g")
          .attr("class", "nodes")
          .selectAll("circle")
          .data(data.nodes)
          .enter().append('g');

      node.append("circle")
          .attr("r", 2)
          .attr("title", function(d){return d.id;});

      node.append('text')
          .text(function(d) {return d.id;});

      var simulation = d3.forceSimulation()
          .force("link", d3.forceLink().id(function(d) {return d.id;})
              .strength(function(d) {return 0.1*d.value**4;})
              .distance(0))
          .force("collide", d3.forceCollide().radius(radius/10).iterations(1))
          .force("radial", d3.forceRadial(radius, center_x, center_y).strength(0.05))
          .force("manybody", d3.forceManyBody().strength(-radius/10));

      var iyear=0;
      function draw_year(iyear){
          svg.selectAll('.links').remove();

          var value_array = data.links[iyear].map(d => d.value)
          var max_value = Math.max(...value_array);
          var min_value = Math.min(...value_array);

          var link = svg.append("g")
              .attr("class", "links")
              .selectAll("line")
              .data(data.links[iyear])
              .enter()
                .append("line").filter(function(d){return d.value**4>0.2;})
              .style("stroke", "black")
              .style("opacity", function(d){return d.value**4/2;})

          simulation
                .nodes(data.nodes)
                .on("tick", () => ticked(link, node));
          simulation.force("link")
                .links(data.links[iyear]);
          simulation.alpha(1).restart();
      }

      draw_year(iyear);
      var button = d3.select("#button button");
      function advance_year(){
          iyear += 1;
          var year = iyear + 1970;
          if(year > 2013){
              console.log("database stops at year 2013")
              iyear -=1;
          }
          else{
              draw_year(iyear);
              button.text(year);
          }
      }
      button.on("click", advance_year);
    }

    d3.json("food_database.json", function(error, data){
      console.log('drawing');
      if (error) throw error;
        draw_data(data);
    });
    </script>
  </body>
</html>
